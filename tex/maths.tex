
\documentclass{report}
\usepackage[margin=1in]{geometry}
\usepackage[T1]{fontenc}
\usepackage{lmodern} % must be loaded with fontenc --- otherwise text will become bitmaps
\usepackage[british]{babel}
\usepackage{csquotes} % will automatically use quotes of the babel language
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{etoolbox}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{listings}
\usepackage{color}
\usepackage[normalem]{ulem}
\usepackage[style=apa]{biblatex} % verbose or apa depending on cite style
\usepackage{xcolor}
\usepackage[
  colorlinks,
  linkcolor=blue,
  citecolor=blue,
  urlcolor=blue
]{hyperref}
\usepackage[capitalize]{cleveref} % use capitalization so that we do not need to worry about detecting beginnings of sentences, etc
\usepackage{import}
\usepackage[useregional]{datetime2}
\usepackage{titlesec}
\usepackage{physics}
\usepackage{float} % for H option in table
\usepackage{parskip} % remove indentation on new paragraphs
\usepackage{caption}
\usepackage[export]{adjustbox} % allow max width
\usepackage{graphbox} % allow align=t in \includegraphics to make them work better in minipages if first item

\MakeOuterQuote{"}

\titleformat{\chapter}[display]{}{}{0pt}{\raggedright\normalfont\bfseries\huge\thechapter\hspace*{1em}}[] % for chapters created from metadata blocks
\titleformat{name=\chapter,numberless}[display]{}{}{0pt}{\raggedright\normalfont\bfseries\huge\phantom{\thechapter}\hspace*{1em}}[] % for unnumbered chapters, including the table of contents
\titlespacing{\chapter}{0pt}{2em}{1em}

\lstset{
  backgroundcolor=\color[rgb]{1,1,1},
  tabsize=4,
  rulecolor=,
  basicstyle=\ttfamily,
  upquote=true,
  aboveskip={1.5\baselineskip},
  columns=fixed,
  showstringspaces=false,
  extendedchars=true,
  breaklines=true,
  prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
  showtabs=false,
  showspaces=false,
  showstringspaces=false,
  identifierstyle=\ttfamily,
  keywordstyle=\color[rgb]{0,0,1},
  commentstyle=\color[rgb]{0.133,0.545,0.133},
  stringstyle=\color[rgb]{0.627,0.126,0.941},
  aboveskip=0pt,
  literate={£}{{\textsterling{}}}1 % allow £ sign within listings
}

\newcommand{\noncolouredtableofcontents}{
  \begingroup
  \hypersetup{hidelinks}
  \tableofcontents
  \endgroup
}

\ifcsundef{thematicbreak}{\newcommand{\thematicbreak}{\par\bigskip\noindent\hrulefill\par\bigskip}}{}

\theoremstyle{definition}
\ifcsundef{definition}{\newtheorem{definition}{Definition}[section]}{}

\theoremstyle{plain}
\ifcsundef{theorem}{\newtheorem{theorem}{Theorem}[section]}{}
\ifcsundef{lemma}{\newtheorem{lemma}[theorem]{Lemma}}{}
\ifcsundef{corollary}{\newtheorem{corollary}{Corollary}[theorem]}{}

\theoremstyle{definition}
\ifcsundef{definition}{\newtheorem{definition}{Definition}[section]}{}
\ifcsundef{example}{\newtheorem{example}{Example}[section]}{}

\theoremstyle{remark}
\ifcsundef{assumption}{\newtheorem*{assumption}{Assumption}}{}
\ifcsundef{proof}{\newtheorem*{proof}{Proof}}{}
\ifcsundef{exercise}{\newtheorem{exercise}{Exercise}[section]}{}
\ifcsundef{problem}{\newtheorem{problem}{Problem}[section]}{}
\ifcsundef{question}{\newtheorem{question}{Question}[section]}{}
\ifcsundef{tip}{\newtheorem*{tip}{Tip}}{}
\ifcsundef{solution}{\newtheorem*{solution}{Solution}}{}
\ifcsundef{note}{\newtheorem{note}{Note}[section]}{}
\ifcsundef{derivation}{\newtheorem{derivation}{Derivation}[section]}{}
\ifcsundef{axiom}{\newtheorem{axiom}{Axiom}[section]}{}
\ifcsundef{conjecture}{\newtheorem{conjecture}{Conjecture}[section]}{}
\ifcsundef{hypothesis}{\newtheorem{hypothesis}{Hypothesis}[section]}{}
\ifcsundef{proposition}{\newtheorem{proposition}{Proposition}[section]}{}

\ifcsundef{remark}{\newtheorem*{remark}{Remark}}{} % notes are numbered but remarks are not

\renewcommand{\qedsymbol}{$\blacksquare$} % closed black square for proof environments

\usepackage{tikz}
\usetikzlibrary{tikzmark, calc}
\renewcommand\thesection{\arabic{section}}

\numberwithin{equation}{section}
\numberwithin{figure}{section}
\numberwithin{table}{section}

\providecommand{\tightlist}{%
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% fix parskip within minipage
\setlength{\parskip}{\medskipamount}
\makeatletter
\newcommand{\@minipagerestore}{\setlength{\parskip}{\medskipamount}}
\makeatother

\begin{document}

\setcounter{secnumdepth}{3}

\section{Maths}
The \textit{noising process} \(q(\vb{z}_{t} \mid \vb{z}_{t-1}, \vb{x})\) is a Markov process which iteratively adds Gaussian noise to data \(\vb{x}\) until the signal is destroyed, \(\vb{z}_{T} \sim \operatorname{N}(\vb{0}, \mathbf{I})\).

We learn a Gaussian \textit{generative denoising process} \(p_{\theta}\) that aims to approximate the \textit{true denoising process} \(q(\vb{z}_{t-1} \mid \vb{z}_{t}, \vb{x})\) without knowledge of the data \(\vb{x}\). Cross-entropy loss (often called NLL in the literature) is intractible, so a variational bound is used:
\[
  \mathop{\mathbb{E}}\qty(-\log p_{\theta}(\vb{x})) \leq \mathop{\mathbb{E}}\qty(- p_{\theta}(\vb{x} \mid \vb{z}_{0})) + \sum_{t=1}^{T} \mathop{\mathbb{E}}\qty[\operatorname{KL}\big( q(\vb{z}_{t-1} \mid \vb{z}_{t}, \vb{x}) \mid \mid p_{\theta}(\vb{z}_{t-1} \mid \vb{z}_{t})\big)]
\]

\textbf{Parameterisation}
The noising process has a marginal distribution \(\vb{z}_{t} \overset{\text{dist.}}{=} \alpha_{t} \vb{x} + \beta_{t}\tikzmarknode{Noise}{\boldsymbol{\varepsilon}}\) where \(\boldsymbol{\varepsilon} \sim \operatorname{N}(\vb{0}, \mathbf{I})\).
\begin{align*}
  \phantom{p_{\theta}(\vb{z}_{t-1} \mid \vb{z}_{t})} &\mathrel{\phantom{\coloneqq}} q(\vb{z}_{t-1} \mid \vb{z}_{t}, \tikzmarknode{Data}{\vb{x}}) \\
  p_{\theta}(\vb{z}_{t-1} \mid \vb{z}_{t}) &\coloneqq q(\vb{z}_{t-1} \mid \vb{z}_{t}, \tikzmarknode{Approx}{\vb{\hat{x}}_{\theta}(\vb{z}_{t}, t)}) \hspace{12em}
\end{align*}
\begin{tikzpicture}[remember picture, overlay]
  \draw[fill=blue!30, opacity=.4] ($(Data.south west) - (1mm, 1mm)$) rectangle ($(Data.north east) + (1mm, 1mm)$) {};
  \draw[fill=blue!30, opacity=.4] ($(Approx.south west) - (1mm, 1mm)$) rectangle ($(Approx.north east) + (1mm, 1mm)$) {};

  \node[fill=blue!10, inner sep=2mm] (Expand) at ($(Approx.east) + (8em, 0pt)$) {\(\frac{1}{\alpha_{t}} \vb{z}_{t} - \frac{\beta_{t}}{\alpha_{t}}\tikzmarknode{ANoise}{\boldsymbol{\hat{\varepsilon}}_{\theta}(\vb{z}_{t}, t)}\)};
  \draw[fill=red!30, opacity=.4] ($(Noise.south west) - (1mm, 1mm)$) rectangle ($(Noise.north east) + (1mm, 1mm)$) {};
  \draw[fill=red!30, opacity=.4] ($(ANoise.south west) - (1mm, 1mm)$) rectangle ($(ANoise.north east) + (1mm, 1mm)$) {};

  \draw[line width=0.5mm, -latex] ($(Data.south east) - (1mm, 1mm)$) to [bend left,looseness=0.8] ($(Approx.north) + (0pt, 1mm)$);
  \draw[line width=0.5mm, -latex] ($(Noise.south east) - (1mm, 1mm)$) to [bend left,looseness=0.8] ($(ANoise.north) + (0pt, 1mm)$);

  \draw[line width=0.5mm, blue!10] ($(Approx.north east) + (1mm, 1mm) - (0, 0.2mm)$) -- ($(Expand.north west) - (-1mm, 0.25mm)$) {};
  \draw[line width=0.5mm, blue!10] ($(Approx.south east) + (1mm, -1mm) - (0, -0.2mm)$) -- ($(Expand.south west) - (-1mm, -0.25mm)$) {};

\end{tikzpicture}

\[
  \mathop{\min} \mathop{\mathbb{E}_{t, \vb{x}, \vb{z}_{t}}}\qty(\norm{\boldsymbol{\varepsilon} - \boldsymbol{\hat{\varepsilon}}_{\theta}(\vb{z}_{t}, t)}^{2})
\]
\end{document}